{% extends 'base.html' %}
{% load static %}

{% block content %}

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{% static 'css/includes.css' %}" type="text/css">

    <style>
        /* Custom CSS for the left-side modal */
        .left-side-modal .modal-dialog {
            max-width: 40%;
            height: 60%;
            margin: 0;
            top: 20%;
            left: 0;
            z-index: 15;
            transform: translate(-100%);
            transition: transform 0.4s ease-in-out;
        }

        .left-side-modal.show .modal-dialog {
            transform: translate(0);
        }
    </style>

    <title>Document</title>
</head>




<html>




<body>

    <!-- Checkout Section Begin -->
    <section class="checkout spad">
        <div class="container">
            <div class="row">
                <!-- <div class="col-lg-12">
                    <h6 class="coupon__link"><span class="icon_tag_alt"></span> <a href="#">Have a coupon?</a> Click
                        here to enter your code.</h6>
                </div> -->
            </div>
            <div class="checkout__order__total">
                <div class="coupon__input ">
                    <button class="btn btn-success" data-target="#leftSideModal" data-toggle="modal">Find Your Coupens</button>
                    <form action="{% url 'check_out' %}" method="POST">
                        {% csrf_token %}
                        {% if messages %}
                        {% for message in messages %}
                        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                            {{ message }}
                            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        {% endfor %}
                        {% endif %}
                        <div class="input-group p-3 d-flex justify-content-end ">
                            <div class="form-group">
                                <label for="coupon-code" >Enter Coupon Code:</label>
                                <div class="row">
                                    <input type="text" class="form-control" id="coupon-code"
                                        placeholder="Enter Coupon Code" name="coupencode" />
                                    <button class="btn btn-danger  " type="submit">Apply</button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            <form action="/order/placeorder/" method="POST" id="addressForm">
                {% csrf_token %}
                <div class="row">
                    <div class="col-lg-8">
                        <h4 class="d-flex justifycontent-between">Choose the Delivery Address</h5>
                            <h5><a class="text-success" data-toggle="modal" data-target="#exampleModal" type="submit"
                                    href="">Add</a>&nbsp;&nbsp;&nbsp; New Addess</h5>
                            <div class="row">
                                <div class="col-lg-6 col-md-6 col-sm-6">
                                    <div class="checkout__form__input">
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-lg-6 col-md-6 col-sm-6">
                                    <div class="checkout__form__input">

                                    </div>
                                </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col-lg-12 col-md-8 col-sm-8">
                                    <div class="checkout__form__input">
                                        {% for i in address_user %}

                                        {% if forloop.counter <= 2 %} <div class="border p-3 ">

                                            <div class="d-flex justify-content-start">
                                                <div class="form-check form-check-inline">
                                                    <input class="form-check-input" type="radio" name="address"
                                                        id="inlineRadio1" value="{{i.id}}" required>
                                                    <label class="form-check-label" for="inlineRadio1"></label>
                                                </div>
                                                <div>
                                                    <a data-toggle="modal" class="text-success"
                                                        data-target="#editModal-{{i.id}}" href="#">Edit</a>
                                                    <a class="text-danger"
                                                        href="/manageadress_delete/{{ i.id }}">Delete</a>
                                                </div>
                                            </div>
                                            <hr>
                                            <span>
                                                {{ i.first_name }}
                                                {{i.last_name}}</span><span>&nbsp;&nbsp;{{i.phonenumber }}</span>
                                            <p>{{ i.address }} {{ i.zip_code }}</p>
                                    </div>
                                    {% endif %}
                                    {% endfor %}
                                </div>
                            </div>
                    </div>
                </div>
                <div class="col-lg-4">
                    <div class="checkout__order">
                        <h5>Your Order</h5>

                        <div class="checkout__order__product">
                            <ul>
                                <li>
                                    <span class="top__text">Product</span>
                                    <span class="top__text__right">Total</span>
                                </li>
                                {% for i in cart %}
                                <li>
                                    {{ forloop.counter }}. {{ i.products.product.name|truncatewords:3 }}
                                    <span>â‚¹ {{ i.products.price }}</span>
                                </li>
                                {% endfor %}
                            </ul>
                        </div>

                        <div class="checkout__order__total">
                            <ul>
                                <li>Subtotal <span> â‚¹ <span id="total_price_display">{{total_price}}</span></span></li>
                                <li>Discount <span>â‚¹ <span id="discount_price_display">{{discount_price}}</span></span>
                                </li>
                                <li>Tax <span>â‚¹ <span id="tax_display">{{tax}}</span></span></li>
                                <li>Grand Total <span>â‚¹ <span id="GrandTotal_display">{{GrandTotal}}</span></span></li>
                            </ul>
                            <input type="hidden" name="total_price" id="total_price_input" value="{{total_price}}">
                            <input type="hidden" name="discount_price" id="discount_price_input"
                                value="{{discount_price}}">
                            <input type="hidden" name="tax" id="tax_input" value="{{tax}}">
                            <input type="hidden" name="GrandTotal" id="GrandTotal_input" value="{{GrandTotal}}">
                        </div>
                        <div class="checkout__order__widget form-check">
                            <label class="form-check-label">
                                Cash on Delivery
                                <input type="radio" value="cod" name="payment-method" id="check-payment" required>
                                <span class="checkmark"></span>
                            </label>
                            <label class="form-check-label">
                                Online Payment
                                <input type="radio" value="op" name="payment-method" id="paypal">
                                <span class="checkmark"></span>
                            </label>
                        </div>

                        <button type="submit" class="site-btn" id="placeOrderButton">Place Order</button>
                        <button type="button" class="site-btn  payonline" id="onlinePaymentButton">Online
                            Payment</button>


                    </div>
            </form>



        </div>
        </div>
        </div>
    </section>
    <!-- Checkout Section End -->


    <!-- Modal  for add the address-->
    <div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title text-light font-weight-5" id="exampleModalLabel">Add Address</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form action="/manageadress/" method="POST">
                        {% csrf_token %}
                        <div class="row">
                            <div class="form-group col-lg-6 col-6 col-md-6">
                                <label for="firstname">Firstname</label>
                                <input type="text" class="form-control" id="firstname" name="firstname">
                            </div>
                            <div class="form-group col-lg-6 col-6 col-md-6">
                                <label for="lastname ">Lastname</label>
                                <input type="text" class="form-control" id="lastname" name="lastname">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="address">Mobile_number</label>
                            <input type="text" class="form-control" id="phonenumber" name="phonenumber" required>
                        </div>

                        <div class="form-group">
                            <label for="address">Address</label>
                            <textarea class="form-control" id="address" name="address" rows="4"></textarea required>
                 </div>
                 <div class="form-group">
                     <label for="pin">Town</label>
                     <input type="text" class="form-control" id="town" name="town" required>
                 </div>
                 <div class="form-group">
                     <label for="locality">Zip_code</label>
                     <input type="text" class="form-control" id="zipcode" name="zipcode" required>
                 </div>
                 <div class="form-group">
                     <label for="district">Nearbylocation</label>
                     <input type="text" class="form-control" id="nearbylocation" name="nearbylocation" required>
                 </div>
                 <div class="form-group">
                     <label for="state">District</label>
                     <input type="text" class="form-control" id="district" name="district" req>
                 </div>
             <button type="submit" class="btn btn-primary">Add Address</button>

             </form>
         </div>
         <div class="modal-footer">
             <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
         </div>
     </div>
 </div>
</div>


<!-- Modal for edit the address -->

{% for i in address_user %}
<div class="modal fade" id="editModal-{{ i.id }}" tabindex="-1" role="dialog" aria-labelledby="editModalLabel" aria-hidden="true">
<div class="modal-dialog" role="document">
 <div class="modal-content">
     <div class="modal-header">
         <h5 class="modal-title" id="editModalLabel">Edit Address</h5>
         <button type="button" class="close" data-dismiss="modal" aria-label="Close">
             <span aria-hidden="true">&times;</span>
         </button>
     </div>
     <div class="modal-body">
         <form action="/manageadress_edit/{{ i.id }}" method="POST">
             {% csrf_token %}
                 <div class="row">
                     <div class="form-group col-lg-6 col-6 col-md-6">
                         <label for="firstname">Firstname</label>
                         <input type="text" class="form-control" id="firstname" value="{{i.first_name}}" name="firstname">
                     </div>
                     <div class="form-group col-lg-6 col-6 col-md-6">
                         <label for="lastname ">Lastname</label>
                         <input type="text" class="form-control" id="lastname" value="{{i.last_name}}" name="lastname">
                     </div>
                 </div>
                 <div class="form-group">
                     <label for="address">Mobile_number</label>
                     <input type="text" class="form-control" id="phonenumber" name="phonenumber" value="{{i.phonenumber}}" required>
                 </div>

                 <div class="form-group">
                     <label for="address">Address</label>
                     <textarea class="form-control" id="address"  name="address" value="{{i.address}}" rows="4"></textarea required>
                 </div>
                 <div class="form-group">
                     <label for="pin">Town</label>
                     <input type="text" class="form-control" id="town" value="{{i.town}}" name="town" required>
                 </div>
                 <div class="form-group">
                     <label for="locality">Zip_code</label>
                     <input type="text" class="form-control" id="zipcode" value="{{i.zip_code}}" name="zipcode" required>
                 </div>
                 <div class="form-group">
                     <label for="district">Nearbylocation</label>
                     <input type="text" class="form-control" id="nearbylocation" value="{{i.nearbylocation}}" name="nearbylocation" required>
                 </div>
                 <div class="form-group">
                     <label for="state">District</label>
                     <input type="text" class="form-control" id="district" value="{{i.district}}" name="district" req>
                 </div>
             <button type="submit" class="btn btn-primary">Add Address</button>
             </form>
         </div>
         <div class="modal-footer">
             <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
         </div>
     </div>
 </div>
</div>
{% endfor %}


<!-- MoDAL FOR COUPEN -->




<div class="modal fade left-side-modal" id="leftSideModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title font-weight-bold" id="exampleModalLabel">Coupens</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                {% for coupen in coupen %}

                <div class="border p-3 bg-black">
                    <div class="font-weight-bold text-light">
                    {{coupen.coupon_title}}
                    </div>
                    <div class="d-flex justify-content-between mt-3">
                        <div class="row">

                        </div>
                        <div>

                        </div>

                        <!-- Add other information here if needed -->
                    </div>

                </div>

                <div class="border p-3">
                    <div class="d-flex justify-content-between mt-3">
                        <div class="row">

                            <!-- <div class="font-weight-bold underline text-decoration-underline">{{coupen.coupon_title}}</div> -->
                            <div>{{coupen.description}}</div>
                            <div>Coupon_code :-{{coupen.coupon_code}} <span class="font-weight-bold"> -- : Choose The Coupen code for get offer</span> </div>
                            <div>Minimum_order_amount :-{{coupen.minimum_order_amount}}</div>
                            <div>{{coupen.}}</div>
                            <div>{{coupen.}}</div>
                            

                        </div>
                        
                    </div>
                </div>
                {% endfor %}
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Exit</button>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap JS and jQuery (make sure to include them) -->
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.3/dist/umd/popper.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>



      <!--Modal: modalDiscount-->
      <div class="modal fade right" id="modalDiscount" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
        aria-hidden="true" data-backdrop="true">
        <div class="modal-dialog modal-side modal-bottom-right modal-notify modal-danger" role="document">
          <!--Content-->
          <div class="modal-content">
            <!--Header-->
            <div class="modal-header">
              <p class="text-center text-black">Order Confirmation</p>
              <button type="button"  class="close"  aria-label="Close">
                <a href="/order/remove-show-modal/" class="text-black"><span aria-hidden="true" class="white-text">&times;</span></a> 
              </button>
            </div>
  
            <!--Body-->
            <div class="modal-body">
  
              <div>
                <h5>Thank Your For Shopping With us !</h5>
                <h5 class="text-ceter"><span class="text-success text-centerðŸ¥³ðŸ¥³ðŸ¥³ðŸ¥³ðŸ¥³ðŸ¥³ðŸ¥³ðŸ¥³ðŸ¥³ðŸ¥³ðŸ¥³">CongratsðŸ¥³ðŸ¥³ðŸ¥³ðŸ¥³ðŸ¥³ðŸ¥³ðŸ¥³ðŸ¥³ðŸ¥³ðŸ¥³ðŸ¥³</span> <hr> Your order is confirmed</h1>
              </div>
            </div>
  
            <!--Footer-->
            <div class="modal-footer flex-center">
              <a href="/order/remove-show-modal/" class="btn btn-danger">
                Exit
                <i class="far fa-gem ml-1 white-text"></i>
              </a>
              <a class="btn btn-outline-danger waves-effect" href="">Check Order Details</a>

              <!-- <a type="submit" class="btn btn-outline-danger waves-effect" data-dismiss="modal" href="/myorder/">Check Orderdetails</a> -->
            </div>
          </div>
          <!--/.Content-->
        </div>
      </div>
      <!--Modal: modalDiscount-->

     

   
      
      <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

      
      <script>
        // Set a JavaScript variable with the session value
        var showModal = '{{ request.session.show_modal|default:"False"|lower }}';
    </script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Check if the JavaScript variable 'showModal' is set to true
            if (showModal === "true") {
                // Display the modal on page load
                $('#modalDiscount').modal('show');

                // Remove the 'show_modal' session variable using a fetch request
                fetch('/order/remove-show-modal/', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrftoken,  // Replace with your CSRF token if needed
                    },
                }).then(function (response) {
                    // Handle the response here if needed
                    if (response.status === 200) {
                        // Session variable removed
                    } else {
                        // Handle error if the removal fails
                    }
                });
            }
        });





    </script>

    <!-- Shop Section End -->
    <!-- Search Begin -->
    <div class="search-model">
        <div class="h-100 d-flex align-items-center justify-content-center">
            <div class="search-close-switch">+</div>
            <form class="search-model-form">
                <input type="text" id="search-input" placeholder="Search here.....">
            </form>
        </div>
    </div>
    <!-- Search End -->

    {% endblock %}
</body>

<!-- success.html -->

{% block scripts %}

<script>

    // Add an event listener to the radio buttons
    var codRadioButton = document.getElementById('check-payment');
    var onlineRadioButton = document.getElementById('paypal');
    var placeOrderButton = document.getElementById('placeOrderButton');
    var onlinePaymentButton = document.getElementById('onlinePaymentButton');
    placeOrderButton.style.display = 'none';
    onlinePaymentButton.style.display = 'none';



    codRadioButton.addEventListener('change', function () {
        if (codRadioButton.checked) {
            // Show the "Place Order" button for COD
            placeOrderButton.style.display = 'block';
            // Hide the "Online Payment" button
            onlinePaymentButton.style.display = 'none';
        }
        else {
            placeOrderButton.style.display = 'none';

        }
    });

    onlineRadioButton.addEventListener('change', function () {
        if (onlineRadioButton.checked) {
            // Show the "Online Payment" button for online payment
            onlinePaymentButton.style.display = 'block';
            // Hide the "Place Order" button
            placeOrderButton.style.display = 'none';
        }
    });

</script>



<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>


    //For sending the details to the back end and collect the address data for initiziate the online payement//

    // Global Variables for shariing the details of the project to diffrent post and access them it in separeatly in the sucess functions

    var addressDetailsFromFirstAjax;

    var selectedAddressId;

    var payement_method_for_Shopping;

    $(document).ready(function () {
        $('input[type=radio][name=address]').change(function () {
            selectedAddressId = $(this).val();
            console.log('Selected Address ID:', selectedAddressId);
            var selectedAddressId1 = $(this).attr('id'); // Retrieve the ID of the selected radio button
            address_id = selectedAddressId

            payement_method_for_Shopping =

                console.log('Selected Address ID:', selectedAddressId1);
            //var selectn =  document.getElementById("addressDetails").textContent
            //console.log(se)
            // Make an AJAX request to retrieve address details
            $.ajax({
                url: '/order/get-address-details/',
                method: 'GET',
                dataType: 'json', // Specify that the response is JSON
                data: { id: selectedAddressId },
                success: function (addressDetails) {


                    // Store the data in the variable
                    addressDetailsFromFirstAjax = addressDetails;

                    // Now, you can access the JSON data directly
                    var first_name = addressDetails.first_name
                    console.log(first_name)
                    console.log('First Name:', addressDetails.first_name);
                    console.log('Last Name:', addressDetails.last_name);
                    console.log('Phone Number:', addressDetails.phonenumber);
                    console.log('Address:', addressDetails.address);
                    console.log('Town:', addressDetails.town);
                    console.log('Zip Code:', addressDetails.zip_code);
                    console.log('Nearby Location:', addressDetails.nearbylocation);
                    console.log('District:', addressDetails.district);
                    console.log('Created:', addressDetails.created);
                    console.log('Id:', selectedAddressId);
                    console.log('payement_method_for_Shopping:', addressDetails.payement_method);

                    // You can also update other parts of your UI with these variables
                    $('#streetInput').val(addressDetails.address);
                    $('#cityInput').val(addressDetails.town);
                    $('#stateInput').val(addressDetails.district);
                },
                error: function (xhr, status, error) {
                    console.error(error);
                }

            });
        });
    });


    $(document).ready(function () {

        $('.payonline').click(function (e) {
            e.preventDefault();
            var formData = new FormData(document.getElementById('addressForm'));
            var first_name = addressDetailsFromFirstAjax.first_name;
            var last_name = addressDetailsFromFirstAjax.last_name;
            var phonenumber = addressDetailsFromFirstAjax.phonenumber;
            var town = addressDetailsFromFirstAjax.town;
            var address = addressDetailsFromFirstAjax.address;
            var district = addressDetailsFromFirstAjax.district;
            var zip_code = addressDetailsFromFirstAjax.zip_code;
            var nearbylocation = addressDetailsFromFirstAjax.nearbylocation;



            if (first_name == "" || last_name == "" || phonenumber == "" || town == "" || address == "" || town == "" || district == "" || zip_code == "" || nearbylocation == "") {
                Swal.fire({
                    icon: 'error',
                    title: 'Oops...',
                    text: 'All fields are madaratory!',
                    footer: '<a href="">Why do I have this issue?</a>'
                })
            }
            else {
                $.ajax({
                    url: '/order/proceed-to-pay/', // Replace with your backend endpoint
                    method: 'POST',
                    data: formData,
                    processData: false, // Prevent jQuery from processing the data
                    contentType: false,
                    success: function (response) {

                        console.log(response)

                        // Data for setting the order

                        var total_price = response.total_price
                        var GrandTotal = response.GrandTotal
                        var discount_price = response.discount_price
                        var tax = response.tax
                        var payement_method = response.payment_method
                        var token = $("[name='csrfmiddlewaretoken']").val()
                        console.log(payement_method)


                        var options = {
                            "key": "rzp_test_RyZUgsGPNnwtiQ", // Enter the Key ID generated from the Dashboard
                            "amount": response.GrandTotal * 100, // Amount is in currency subunits. Default currency is INR. Hence, 50000 refers to 50000 paise
                            "currency": "INR",
                            "name": "Ntk Online Shopping ", //your business name
                            "description": "Thanku for Choosing us , Have a Great Day",
                            "image": "https://t3.ftcdn.net/jpg/05/29/41/96/360_F_529419639_eFk62uXuzFexGwZR5Xi6zYwiAQvaxSjM.jpg",
                            //"order_id": "order_9A33XWu170gUtm", //This is a sample Order ID. Pass the `id` obtained in the response of Step 1
                            "handler": function (response) {
                                //alert(response.razorpay_payment_id);
                                data = {
                                    "address": selectedAddressId,
                                    "total_price": total_price,
                                    "GrandTotal": GrandTotal,
                                    "discount_price": discount_price,
                                    "tax": tax,
                                    "payment-method": payement_method,
                                    csrfmiddlewaretoken: token
                                }
                                $.ajax({
                                    method: 'POST',  // Corrected method definition
                                    url: "/order/placeorder/",
                                    data: data,
                                    success: function (responseB) {

                                        Swal.fire({
                                            position: 'center',
                                            icon: 'success',
                                            title: '<span style="font-weight: bold; font-size: 18px;">Thank You for Shopping With Us</span>',
                                            html: '<p style="font-size: 16px;">Your Order Number is: <strong>' + responseB.order_id + '</strong></p>',
                                            footer: '<a href="/myorder/" style="font-size: 14px;">Go to My Orders</a>',
                                            showConfirmButton: false,
                                            width: '50%',
                                        });

                                        // Handle the success of the AJAX request here
                                    },
                                    // You can also handle error and other events as needed
                                });


                            },
                            "prefill": { //We recommend using the prefill parameter to auto-fill customer's contact information, especially their phone number
                                "name": first_name + " " + last_name, //your customer's name
                                "email": "None",
                                "contact": phonenumber  //Provide the customer's phone number for better conversion rates 
                            },
                            "notes": {
                                "address": "Ntk Online Shopping Co.Ltd"
                            },
                            "theme": {
                                "color": "#3399cc"
                            }
                        };
                        var rzp1 = new Razorpay(options);
                        rzp1.on('payment.failed', function (response) {
                            alert(response.error.code);
                            alert(response.error.description);
                            alert(response.error.source);
                            alert(response.error.step);
                            alert(response.error.reason);
                            alert(response.error.metadata.order_id);
                            alert(response.error.metadata.payment_id);
                        });

                        rzp1.open();


                    },
                    error: function (xhr, status, error) {
                        console.error(error);
                    }

                });


            }




        });
    });

</script>

{% endblock scripts %}



</html>